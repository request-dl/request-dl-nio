name: Code Coverage

on:
  push:
    branches: [main]
    paths:
      - 'Package.swift'
      - 'Sources/**'
      - 'Tests/**'
  pull_request:
    paths:
      - 'Package.swift'
      - 'Sources/**'
      - 'Tests/**'
      - '.github/workflows/code-coverage.yml'

jobs:
  third-party-tests:
    strategy:
      matrix:
        include:
          - os: ubuntu-latest
            swift-version: '6.1'
          - os: windows-latest
            swift-version: '5.10'
    uses: request-dl/.github/.github/workflows/third-party-tests.yml@coverage-workflow
    with:
      platform: ${{ matrix.os }}
      swift-version: ${{ matrix.swift-version }}
      coverage-enabled: true
    secrets: inherit

  apple-tests:
    strategy:
      fail-fast: false
      matrix:
        destination:
          - "platform=iOS Simulator,arch=arm64,name=iPhone 16 Pro,OS=18.5"
          - "platform=iOS Simulator,arch=arm64,name=iPad (A16),OS=18.5"
          - "platform=watchOS Simulator,arch=arm64,name=Apple Watch Series 10 (42mm),OS=11.5"
          - "platform=tvOS Simulator,arch=arm64,name=Apple TV 4K (3rd generation) (at 1080p),OS=18.5"
          - "platform=visionOS Simulator,arch=arm64,name=Apple Vision Pro,OS=2.5"
          - "platform=macOS,arch=arm64,name=My Mac"
          - "platform=macOS,arch=arm64,variant=Mac Catalyst,name=My Mac"

    uses: request-dl/.github/.github/workflows/apple-tests.yml@coverage-workflow
    with:
      package-name: "request-dl"
      destination: ${{ matrix.destination }}
      coverage-enabled: true
    secrets: inherit

  coverage-upload:
    needs: [third-party-tests, apple-tests]
    if: always() # ⬅️ Importante: executa mesmo se alguns jobs falharem
    uses: request-dl/.github/.github/workflows/coverage-upload.yml@coverage-workflow
    secrets: inherit